
import pytest
import uonidtoolbox as unit
import numpy as np


@pytest.mark.matlab
def test_matlabResult_Mtype_AR():
    Z = {}
    Z['y'] = np.array([0.3689, 1.7332, 4.4612, 8.6571, 14.1025, 19.9205, 25.1013, 28.6412, 29.6255, 27.9823, 24.3297, 19.6076, 14.9241, 11.4991, 10.1617, 11.0637, 13.7449, 17.2860, 20.3594, 22.1273, 22.6871, 22.2647, 21.7503, 21.7766, 22.4222, 23.0887, 22.8530, 20.8312, 16.9178, 12.2047, 8.1746, 6.1802, 7.1880, 10.3238, 13.9558, 16.6593, 17.7819, 16.8473, 13.6191, 8.7625, 3.3752, -1.2232, -4.3543, -6.3534, -7.5214, -7.7184, -6.3560, -3.7456, -1.0647, 0.1189, -1.0943, -4.8182, -9.8748, -15.1380, -20.1121, -24.3101, -26.8854, -27.5187, -26.7431, -25.3383, -24.4567, -24.7742, -26.0167, -27.3826, -28.6450, -29.8255, -30.9399, -31.2633, -29.8637, -26.3731, -20.7224, -13.8470, -7.1985, -1.6368, 2.8426, 6.6485, 10.1993, 13.4056, 16.1677, 18.0377, 18.8201, 18.6230, 18.0602, 17.5344, 17.3998, 17.9912, 19.0084, 19.9550, 20.8642, 21.8105, 22.6187, 23.1577, 23.2020, 22.7213, 21.7322, 20.3055, 18.7144, 17.6494, 17.6896, 19.4331]).reshape(1,100)

    M = {}
    M['nA']     = 5
    M['T']      = 1
    M['type']   = 'ar'

    OPT = {}
    OPT['dsp'] = 0

    Z   = unit.startZ(Z)
    M   = unit.startM(Z,M)
    OPT = unit.startOPT(OPT,M)

    ep_py = unit.estmap(Z,M,OPT)
    ep_ml = unit.testing._utils.helper_callMatlab_estmap(Z,M,OPT)

    np.testing.assert_equal(ep_py.keys(), ep_ml.keys())
    for k in ep_py.keys():
        if isinstance(ep_py[k], np.ndarray):
            np.testing.assert_allclose(ep_py[k], ep_ml[k])
        elif k == 'modelEquations':
            # a mismatch between printed strings is not critical for functionality of toolbox
            pass # ignore modelEquations string
        else:
            np.testing.assert_equal(ep_py[k], ep_ml[k], k)
        #endif
    #endfor
#endfunction

@pytest.mark.matlab
def test_matlabResult_Mtype_ARMA():
    Z = {}
    Z['y'] = np.array([-0.6414, -1.2702, -1.6709, -2.1127, -2.6331, -2.6047, -2.1535, -1.4578, -0.6231, -0.2227, -0.1690, -0.3604, -0.9009, -1.2931, -0.8250, -0.4794, 0.1758, 0.3859, 0.9157, 0.8542, 0.7340, 0.2724, -0.0139, -0.2549, -0.3777, 0.5664, 1.1882, 1.7230, 2.8352, 3.0762, 3.1665, 2.5065, 2.0137, 1.5180, 1.3144, 1.1304, 1.1657, 1.7187, 1.4472, 0.6970, 0.1014, -0.6432, -1.2211, -1.9671, -2.5832, -2.9261, -3.1203, -3.2308, -3.1741, -3.2030, -2.6119, -2.3326, -1.4115, -0.8117, -0.8238, -1.1635, -1.2944, -1.1234, -0.8689, -0.4708, 0.0936, 0.0606, -0.2149, -1.1426, -2.0622, -2.4288, -2.2597, -1.0636, 0.2026, 0.6426, 1.3806, 2.0113, 2.0155, 1.7967, 1.5848, 1.3625, 1.3454, 1.2884, 1.2502, 1.2373, 0.9493, 1.1422, 1.2444, 1.5411, 1.4447, 0.9505, 0.4163, -0.1565, -0.1855, 0.0992, 0.6571, 0.7233, 0.4505, 0.1675, -0.2749, -0.2215, 0.2952, 0.6218, 1.2096, 2.0231]).reshape(1,100)

    M = {}
    M['A']      = 5
    M['C']      = 5
    M['T']      = 1
    M['type']   = 'arma'

    OPT = {}
    OPT['dsp'] = 0

    Z   = unit.startZ(Z)
    M   = unit.startM(Z,M)
    OPT = unit.startOPT(OPT,M)

    ep_py = unit.estmap(Z,M,OPT)
    ep_ml = unit.testing._utils.helper_callMatlab_estmap(Z,M,OPT)

    np.testing.assert_equal(ep_py.keys(), ep_ml.keys())
    for k in ep_py.keys():
        if isinstance(ep_py[k], np.ndarray):
            np.testing.assert_allclose(ep_py[k], ep_ml[k])
        elif k == 'modelEquations':
            # a mismatch between printed strings is not critical for functionality of toolbox
            pass # ignore modelEquations string
        else:
            np.testing.assert_equal(ep_py[k], ep_ml[k], k)
        #endif
    #endfor
#endfunction

@pytest.mark.matlab
def test_matlabResult_Mtype_FIR():
    Z = {}
    Z['u'] = np.array([    0.5232,    1.0573,    0.5370,   -1.2017,   -1.2442,    0.8720,   -0.6385,    1.1542,   -1.1342,    0.5367,   -0.9635,   -0.5345,   -0.6775,    1.2523,    0.8007,    0.1940,    1.2876,   -0.9579,   -1.7154,    0.4361,    0.0607,    0.0681,   -0.9256,    0.7080,    0.4988,   -1.3223,   -0.0442,    1.2088,   -0.0925,    2.0257,    0.0719,   -0.2465,   -1.2817,    0.0208,    0.5974,    1.8868,   -0.8104,   -0.2102,    0.0775,    0.3354,    0.4301,    1.4799,    0.7109,   -0.5598,    2.4032,   -0.5507,    0.4246,    1.4923,    1.5600,   -1.0089,   -0.1718,   -0.7740,   -0.1394,   -0.1550,   -1.2728,    0.3790,    0.4202,   -0.1946,   -0.4459,   -0.3382,   -2.2165,   -1.1735,   -0.9108,    0.1516,    0.2231,   -0.4196,    0.5840,    0.2523,    0.8537,   -0.0396,    0.0945,    0.6210,    0.0306,    1.0699,   -0.6220,    0.4593,   -0.1500,    0.4346,   -0.8360,    0.7983,   -2.4072,   -0.6924,    2.1643,    1.6554,    0.0690,   -1.0090,   -0.5831,   -0.6838,    0.5609,    1.6452,   -0.1355,   -0.0529,   -0.1590,    1.2492,   -0.2796,    0.3156,   -1.0032,    0.7361,   -1.2447,    0.4571,   -0.9373,    3.1217,    0.2497,   -0.8119,   -0.2005,    1.2755,    0.0157,   -1.5620,    0.8051,   -0.1986,   -0.9414,    1.4032,    0.1968,   -1.0662,    1.6529,    1.1106,   -1.3146,    0.2281,    0.7811,   -0.7594,    0.4062,   -0.1209,   -0.2133,   -1.0370,    1.3459,    0.4809,   -0.0405,    0.2003,    1.4204,   -0.2295,   -0.6903,    0.4025,    0.9057,   -0.3841,   -1.2835,   -1.7139,   -1.1322,    1.5351,    0.9897,   -1.1704,   -0.1884,    0.3106,   -0.6615,    0.3304,   -0.7170,   -1.1122,   -0.9600,    0.6121,   -0.4319,   -0.3839,   -0.0372,   -0.9757,   -0.5389,    0.6558,    0.9936,   -0.0303,    0.2298,   -0.7746,   -0.4812,   -0.4065,    0.5237,   -0.2477,    1.1456,   -1.0216,    0.3023,   -0.6461,    0.0264,    0.1210,   -2.1459,   -0.2080,   -0.6930,    1.9678,    1.0464,   -0.1653,   -0.5798,   -0.2172,    0.2401,    1.0212,   -0.0902,    0.8393,   -0.2974,    1.1550,   -0.4453,   -1.1094,    1.1408,    0.9331,   -0.5206,   -0.5897,    1.3814,   -0.3043,    0.1954,    1.1588,    0.0330,   -0.9552,   -0.2731,    1.1578,   -0.7038,    1.1412,   -0.1581,   -0.9685,   -0.8927,    0.9095,    0.3323,    0.2708,   -1.4823,    1.1944,   -0.1312,    0.4161]).reshape(1, 208)
    Z['y'] = np.array([    0.0134,   -0.0109,    0.0100,    0.0051,    0.0161,    0.0582,    0.0454,    0.0448,    0.0241,    0.0339,    0.0168,    0.0234,   -0.0006,   -0.0043,    0.0002,   -0.0304,   -0.0448,   -0.0346,   -0.0308,   -0.0009,    0.0108,    0.0085,   -0.0141,   -0.0099,   -0.0195,   -0.0282,   -0.0386,   -0.0451,   -0.0448,   -0.0497,   -0.0433,   -0.0146,    0.0127,    0.0278,    0.0440,    0.0588,    0.0470,    0.0707,    0.0858,    0.0882,    0.0950,    0.1031,    0.1044,    0.1434,    0.1506,    0.1653,    0.1987,    0.2445,    0.2384,    0.2919,    0.3296,    0.3554,    0.3491,    0.3814,    0.3497,    0.3353,    0.2954,    0.2674,    0.2230,    0.2038,    0.1700,    0.1428,    0.1049,    0.0476,   -0.0028,   -0.0662,   -0.1401,   -0.1538,   -0.1613,   -0.1726,   -0.1608,   -0.1772,   -0.1401,   -0.1305,   -0.1005,   -0.0759,   -0.0481,   -0.0257,   -0.0111,   -0.0124,    0.0111,    0.0151,    0.0179,   -0.0191,    0.0009,    0.0144,    0.0044,    0.0292,    0.0285,    0.0245,    0.0336,    0.0285,    0.0347,    0.0392,    0.0608,    0.0759,    0.0874,    0.1011,    0.1097,    0.1137,    0.0915,    0.0882,    0.0808,    0.0799,    0.0952,    0.0927,    0.1178,    0.1182,    0.1311,    0.1532,    0.1302,    0.1274,    0.0884,    0.1147,    0.1175,    0.0842,    0.0954,    0.1000,    0.0944,    0.1059,    0.1244,    0.1270,    0.1337,    0.1212,    0.1146,    0.1214,    0.0904,    0.0870,    0.1006,    0.1052,    0.1105,    0.1232,    0.1238,    0.1487,    0.1462,    0.1555,    0.1510,    0.1216,    0.0571,    0.0573,    0.0201,    0.0080,   -0.0082,   -0.0408,   -0.0215,   -0.0445,   -0.0536,   -0.0814,   -0.0994,   -0.1275,   -0.1498,   -0.1543,   -0.1810,   -0.2080,   -0.2081,   -0.2308,   -0.2271,   -0.2160,   -0.1846,   -0.1817,   -0.1863,   -0.1742,   -0.1602,   -0.1611,   -0.1523,   -0.1580,   -0.1389,   -0.1210,   -0.1347,   -0.1201,   -0.1303,   -0.1494,   -0.1709,   -0.1595,   -0.1766,   -0.1371,   -0.1324,   -0.1195,   -0.0970,   -0.0805,   -0.0336,   -0.0554,   -0.0098,    0.0191,    0.0365,    0.0444,    0.0607,    0.0416,    0.0892,    0.0922,    0.1066,    0.1021,    0.1145,    0.1257,    0.1240,    0.1599,    0.1223,    0.1428,    0.1331,    0.1491,    0.1430,    0.1138,    0.1347,    0.0997,    0.0830,    0.0818,    0.0838,    0.0653]).reshape(1, 208)

    M = {}
    M['nB']     = 103
    M['T']      = 0.1
    M['type']   = 'fir'

    OPT = {}
    OPT['dsp'] = 0

    Z   = unit.startZ(Z)
    M   = unit.startM(Z,M)
    OPT = unit.startOPT(OPT,M)

    ep_py = unit.estmap(Z,M,OPT)
    ep_ml = unit.testing._utils.helper_callMatlab_estmap(Z,M,OPT)

    np.testing.assert_equal(ep_py.keys(), ep_ml.keys())
    for k in ep_py.keys():
        if isinstance(ep_py[k], np.ndarray):
            np.testing.assert_allclose(ep_py[k], ep_ml[k])
        elif k == 'modelEquations':
            # a mismatch between printed strings is not critical for functionality of toolbox
            pass # ignore modelEquations string
        else:
            np.testing.assert_equal(ep_py[k], ep_ml[k], k)
        #endif
    #endfor
#endfunction

@pytest.mark.matlab
def test_matlabResult_Mtype_SS():
    Z = {}
    Z['u'] = np.array([0,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  1,  1,  1,  1,  1,  1,  1,  1,  1]).reshape([1, 50])
    Z['y'] = np.array([0.1505,  0.4466,  0.0082, -0.0021,  0.5915, -0.0233,  0.2751,  0.7622,  0.7694,  1.4671,  1.6932,  1.8357,  1.8977,  2.7174,  2.4473,  3.2220,  3.5492,  3.3869,  3.5003,  3.6540,  2.9860,  2.3764,  2.0255,  1.4569,  0.4260,  0.2941,  0.4930, -0.1151, -0.0061, -0.4835, -0.0158,  0.3729,  0.0449,  0.9156,  1.0666,  1.0895,  1.5500,  1.0335,  0.9223,  1.0800,  0.9004,  0.5220, -0.0388,  0.1815, -0.8116, -0.6079, -0.6360, -1.0180, -1.0058, -1.0628]).reshape([1, 50])

    M = {}
    M['nx']     = 4
    M['T']      = 1
    M['type']   = 'ss'

    OPT = {}
    OPT['dsp'] = 0

    Z   = unit.startZ(Z)
    M   = unit.startM(Z,M)
    OPT = unit.startOPT(OPT,M)

    ep_py = unit.estmap(Z,M,OPT)
    ep_ml = unit.testing._utils.helper_callMatlab_estmap(Z,M,OPT)

    np.testing.assert_equal(ep_py.keys(), ep_ml.keys())
    for k in ep_py.keys():
        if isinstance(ep_py[k], np.ndarray):
            np.testing.assert_allclose(ep_py[k], ep_ml[k])
        elif k == 'modelEquations':
            # a mismatch between printed strings is not critical for functionality of toolbox
            pass # ignore modelEquations string
        else:
            np.testing.assert_equal(ep_py[k], ep_ml[k], k)
        #endif
    #endfor
#endfunction

